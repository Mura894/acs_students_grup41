@startuml
!theme plain
skinparam classAttributeIconSize 0
title Sistema de Control de Acceso - Diagrama de Clases

' === NÚCLEO DEL SISTEMA ===
class Main {
  + {static} main(args: String[])
}

class WebServer {
  - {static} PORT: int
  + WebServer()
}

class SocketThread {
  - insocked: Socket
  + run()
}

WebServer +-right- SocketThread

' === SISTEMA DE PUERTAS Y ESTADOS ===
class Door {
  - id: String
  - closed: boolean
  - state: State
  + processRequest(request: RequestReader)
  + setState(state: State)
  + toJson(): JSONObject
}

abstract class State {
  + {abstract} lock()
  + {abstract} unlock()
  + {abstract} unlockShortly()
  + {abstract} setDoor(door: Door)
  + {abstract} getState(): String
  + {abstract} intClock()
}

class Locked {
  + lock()
  + unlock()
  + unlockShortly()
}

class Unlocked {
  + lock()
  + unlock()
  + unlockShortly()
}

class UnlockedShortly {
  - dateTime: LocalDateTime
  - clock: Clock
  + update(Observable, Object)
  + intClock()
}

class Propped {
  + lock()
  + unlock()
  + unlockShortly()
}

Door *--> "1" State : state
State <|-- Locked
State <|-- Unlocked
State <|-- UnlockedShortly
State <|-- Propped

' === SISTEMA DE ÁREAS (COMPOSITE) ===
abstract class Area {
  + {abstract} getName(): String
  + {abstract} getDoorsGivingAccess(): ArrayList<Door>
  + {abstract} findAreaById(name: String): Area
  + {abstract} toJson(depth: int): JSONObject
}

class Space extends Area {
  - doorList: ArrayList<Door>
  - name: String
  + addDoor(id: String)
}

class Partition extends Area {
  - areas: ArrayList<Area>
  - name: String
  + add(area: Area)
}

Partition *--> "0..*" Area : areas

class DirectoryAreas {
  - {static} instance: DirectoryAreas
  - {static} allAreas: ArrayList<Area>
  + {static} getInstance(): DirectoryAreas
  + {static} findAreaById(name: String): Area
}

DirectoryAreas --> "*" Area : allAreas
Space --> "*" Door : doorList

' === SISTEMA DE USUARIOS Y PERMISOS ===
class User {
  - name: String
  - credential: String
  - group: Group
  + canAccess(area: Area, action: String, now: LocalDateTime): boolean
}

class Group {
  - name: String
  - actions: ArrayList<String>
  - users: ArrayList<User>
  - areas: ArrayList<Area>
  - schedule: Schedule
  + canAccess(area: Area, action: String, now: LocalDateTime): boolean
}

class Schedule {
  - fromDate: LocalDateTime
  - toDate: LocalDateTime
  - fromHour: LocalTime
  - toHour: LocalTime
  + canAccess(now: LocalDateTime): int
}

User --> "1" Group : group
Group --> "1" Schedule : schedule
Group --> "*" Area : areas

class DirectoryUsers {
  - {static} users: ArrayList<User>
  + {static} findUserByCredential(credential: String): User
}

DirectoryUsers --> "*" User : users

' === SISTEMA DE REQUESTS ===
interface Request {
  + process()
  + answerToJson(): JSONObject
}

class RequestReader implements Request {
  - credential: String
  - action: String
  - doorId: String
  - now: LocalDateTime
  + process()
}

class RequestArea implements Request {
  - areaId: String
  - requests: ArrayList<RequestReader>
  + process()
}

RequestArea --> "*" RequestReader : requests

' === SISTEMA DE TIEMPO ===
class Clock extends Observable implements Runnable {
  - {static} instance: Clock
  - running: boolean
  + {static} getInstance(): Clock
  + run()
}

UnlockedShortly .up.> Clock : observes

' === DIRECTORIO DE PUERTAS ===
class DirectoryDoors {
  - {static} allDoors: ArrayList<Door>
  + {static} findDoorById(id: String): Door
}

DirectoryDoors --> "*" Door : allDoors

' === RELACIONES PRINCIPALES ===
Main --> WebServer : creates
SocketThread --> Request : processes
RequestReader --> DirectoryUsers : queries
RequestReader --> DirectoryDoors : queries
RequestReader --> Door : processes
RequestArea --> DirectoryAreas : queries

' === NOTAS EXPLICATIVAS ===
note top of State
<b>State Pattern</b>
Comportamiento polimórfico
para estados de puerta
end note

note top of Partition
<b>Composite Pattern</b>
Jerarquía recursiva
de áreas y espacios
end note

note top of Clock
<b>Observer Pattern</b>
Notificaciones cada segundo
para transiciones automáticas
end note

@enduml